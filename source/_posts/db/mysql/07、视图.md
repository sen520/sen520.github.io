---
title: mysql视图
date: 2019-12-24
tags:
- 数据库
- 后端
- mysql
categories:
- 数据库
- mysql
---

视图是虚拟的表，只包含使用时动态检索的查询

例如：下面的语句

```sql
SELECT cust_name, cust_contact 
FROM customers, orders, orderitems 
WHERE customers.cust_id = orders.cust_id AND orderitems.order_num = orders.order_num AND prod_id = 'TNT2';
```
这个查询用来检索订购了某个特定产品的客户。任何需要这个数据的人都必须理解相关表的结构，并且知道如何创建查询和对表进行联结。为了检索其他产品（或多个产品）的相同数据，必须修改最后的WHERE子句。

使用视图后，语句变成

`SELECT cust_name, cust_contact FROM productcustomers WHERE prod_id = 'TNT2';` 其中，`productcustomers`是一个视图

### 应用

- 重用SQL语句
- 简化复杂的SQL操作。在编写查询后，可以方便地重用它而不必知道它的基本查询细节
- 使用表的组成部分而不是整个表
- 保护数据。可以给用户授予表的特定部分的访问权限而不是整个表的访问权限
- 更改数据格式和表示。视图可以返回与底层表的表示和格式不同的数据

视图仅仅是用来查看存储在别处的数据的一种设施，视图本身不包含数据，因此它们返回的数据是从其他表中检索出来的。在添加或更改这些表中的数据时，视图将返回改变过的数据。

**性能问题：**因为视图不包含数据，所以每次使用视图时，都必须处理查询执行时所需的任一个检索。如果用了多个联结和过滤创建了复杂的视图，可能会发现性能下降的厉害。

### 视图的规则和限制

- 与表一样，视图必须唯一命名（不能给视图取与别的视图或表相同的名字）
- 对于可以创建的视图数目没有限制
- 为了创建视图，必须具有足够的访问权限。这些限制通常由数据库管理人员授予
- 视图可以嵌套，即可以利用从其他视图中检索数据的查询来构造一个视图
- `ORDER BY`可以用在视图中，但如果从该视图检索数据的`SELECT`语句中也含有`ORDER BY`，那么该视图中的`ORDER BY`将被覆盖
- 视图不能索引，也不能有关联的触发器或默认值
- 视图可以和表一起使用，例如，编写一条联结表和视图的`SELECT`语句

### 使用视图

- 利用视图简化复杂的联结

    ```sql
    CREATE VIEW productcustomers AS
    SELECT cust_name, cust_contact, prod_id 
    FROM customers, orders, orderitems 
    WHERE customers.cust_id = orders.cust_id AND orderitems.order_num = orders.order_num;
    ```
```

    这条语句创建一个名为`productcustomers`的视图，它联结三个表，以返回已订购了任意产品的所有客户的列表。如果执行`SELECT * FROM productcustomers;`，将列出订购了任意产品的客户。
    
    为了检索订购了产品`TNT2`的客户，可进行下面查询
    
    ```SQL
    SELECT cust_name, cust_contact 
    FROM productcustomers
    WHERE prod_id = 'TNT2';
```

    <img src="http://silencew.cn/uploads/blog/1577238271319.png" style="zoom:80%;" />

- 用视图重新格式化检索出的数据

    普通`sql`

    ```sql
    SELECT Contact(RTrim(vend_name), ' (', RTrim(vend_country), ')') AS vend_title
    FROM vendors
    ORDER BY vend_name;
    ```

    <img src="http://silencew.cn/uploads/blog/1577238436928.png" style="zoom:80%;" />

    如果经常需要这个格式的结果，不必在每次需要时执行联结，创建一个视图，每次需要时使用它即可

    ```sql
    CREATE VIEW vendorlocations AS SELECT Contact(RTrim(vend_name), ' (', RTrim(vend_country), ')') AS vend_title
    FROM vendors
    ORDER BY vend_name;
    ```
    
- 利用视图过滤不想要的数据

    ```SQL
    CREATE VIEW customeremaillist AS 
    SELECT cust_id, cust_name, cust_email
    FROM customers
    WHERE cust_email IS NOT NULL;
    ```

    如果在视图检索数据时使用了一条WHERE子句，则两组子句（一组在视图中，另一组是传递给视图的）将自动组合

- 使用视图与计算字段

    ```sql
    CREAET VIEW orderitemsexpanded AS 
    SELECT order_num,
    	prod_id,
    	quantity,
    	item_price,
    	quantity * item_price AS expanded_price
    FROM orderitems;
    ```

### 更新视图

通常，视图是可更新的（可以对它们使用`INSERT`, `UPDATE`, `DELETE`）。更新一个视图将更新其基表，如果你对视图增加或删除行，实际上是对其基表增加或删除行。

但是，并非所有的视图都是可更新的。如果MySQL不能正确地确定被更新的基数据，则不允许更新。这意味着，当视图定义中有以下操作，则不能进行视图更新：

- 分组（使用`GROUP BY` 和 `HAVING`）
- 联结
- 子查询
- 并
- 聚集函数（`Min()`, `Count()`, `Sum()`等）
- `DISTINCT`
- 导出（计算）列

