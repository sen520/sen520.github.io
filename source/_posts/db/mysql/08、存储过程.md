---
title: mysql存储过程
date: 2019-12-25
tags:
- 数据库
- 后端
- mysql
categories:
- 数据库
- mysql
---

### 使用存储过程

MySQL称存储过程的执行为调用，因此MySQL执行存储过程的语句为CALL。CALL接受存储过程的名字以及需要传递给它的任意参数

```SQL
CALL productpricing(@pricelow,
	@pricehigh,
	@priceaverage);
```

执行名为`productpricing`的存储过程，计算返回产品的最低，最高和平均价格。

```sql
-- 一个返回产品平均价格的存储过程
CREATE PROCEDURE productpricing()
BEGIN
	SELECT Avg(prod_price) AS priceaverage
	FROM products;
END;
```

上述代码创建一个名为`productpricing`的存储过程。如果存储过程接受参数，他们会在`()`中列举出来。

使用这个存储过程


```sql
CALL productpricing(); -- 执行刚创建的存储过程并显示返回的结果
```

{% asset_img slug 1577243294747.png %}

**存储过程实际上是一种函数**

### 删除存储过程

存储过程在创建之后，被保存在服务器上以供使用，直至被删除

```sql
DROP PROCEDURE productpricing;
```

如果指定的过程不存在，则DROP PROCEDURE将产生一个错误。也可以使用`DROP PROCEDURE IF EXISTS`

### 使用参数

```sql
CREATE PROCEDURE productpricing(
	OUT pl DECIMAL(8, 2),
	OUT ph DECIMAL(8, 2),
	OUT pa DECIMAL(8, 2)
)
BEGIN
	SELECT Min(prod_price)
	INTO p1
	FROM products;
	SELECT Max(prod_price)
	INTO ph
	FROM products;
	SELECT Avg(prod_price)
	INTO pa
	FROM products;
END;
/* 
	此存储过程接受3个参数：pl存储产品最低价格，ph存储产品最高价格，pa存储产品平均价格。每个参数必须具有指定的类型，这里使用十进制值。关键字OUT指出相应的参数用来从存储过程传出一个值（返回给调用者）。MySQL支持IN（传递给存储过程）、OUT(从存储过程传出)和INOUT（对存储过程传入和传出）类型的参数。
	这里存储过程的代码是一系列的SELECT语句，用来检索值，然后保存到响应的变量（通过INTO关键字）
*/
```

**所有的MySQL变量都必须以@开始**

```
CALL productpricing(@pricelow,
					@pricehigh,
					@priceaverage);
SELECT @pricehigh, @pricelow, @priceaverage;
```

{% asset_img slug 1577244249734.png %}

下面使用IN和OUT参数，`ordertotal`接受订单号，并返回该订单的合计

```SQL
CREATE PROCEDURE ordertotal(
	IN onumber INT,
	OUT ototal DECIMAL(8, 2)
)
BEGIN
	SELECT Sum(item_price*quantity)
	FROM orderitems
	WHERE order_num = onumber
	INTO ototal;
END;
```

调用这个存储过程

```SQL
CALL ordertotal(20005, @total);
SELECT @total;
```

### 样例

这样一个场景，需要获得与以前一样的订单合计，但需要对合计增加营业税，不过只针对某些顾客（或许是你所在州中那些顾客），那么需要做下面几件事：

- 获得合计
- 把营业税有条件的添加到合计
- 返回合计

```SQL
-- Name: ordertotal
-- Parameters: onumber = order number
-- 			   taxable = 0 if not taxable, 1 if taxable
-- 			   ototal = order total variable
CREATE PROCEDURE ordertotal(
	IN onumber INT,
    IN taxable BOOLEAN,
    OUT ototal DECIMAL(8, 2)
) COMMENT 'Obtain order total, optionally adding tax'
BEGIN
	-- Declare variable for total
	DECLARE total DECIMAL(8, 2);
	-- Declare tax percentage
	DECLARE taxrate INT DEFAULT 6;
	
	-- Get the order total
	SELECT Sum(item_price*quantity)
	FROM orderitems
	WHERE order_num = onumber
	INTO total;
	
	-- Is this taxable?
	IF taxable THEN
		-- Yes, so add taxrate to the total
		SELECT total + (total/100*taxrate) INTO total;
	END IF;
	-- And finally, save to out variable
	SELECT total INTO ototal;
END;
```

COMMENT关键字是不必需的，如果给出，将在`SHOW PROCEDURE STATUS` 的结果中显示

```sql
CALL ordertotal(20005, 0, @total);
SELECT @total;
```

{% asset_img slug 1577245465736.png %}

```sql
CALL ordertotal(20005, 1, @total);
SELECT @total;
```

{% asset_img slug 1577245481482.png %}

### 检查存储过程

为显示用来创建一个存储过程的`CREATE`语句

```sql
SHOW CREATE PROCEDURE ordertotal;
```

为获得包括何时，由谁创建等详细信息的存储过程列表

```SQL
SHOW PROCEDURE STATUS;

-- 限制过程状态结果，可以用LIKE指定一个过滤模式
SHOW PROCEDURE STATUS LIKE 'ordertotal';
```



